{% extends "core/html/layouts/base.html" %}

{% block title %} Users System {% endblock %}

<!-- Element injected in the BODY element -->
{% block body_class %} {% endblock body_class %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}

{% include 'core/html/includes/index/stylesheets.html' %}
{% include 'core/html/includes/core/stylesheets.html' %}

{% endblock stylesheets %}

{% block content %}

<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="float-start mr-2">USERS</h1>
                    <h3 class="card-title mt-2">Akun Manajemen</h3>
                </div>
                <div class="col-sm-6">
                    <div class="float-end"><button type="button" id="btnTambah" class="btn btn-block btn-info btn-sm">TAMBAH</button></div>
                </div>
            </div>
        </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                        </div>
                        <!-- /.card-header -->
                        <div class="card-body">
                            <table id="table_" class="table table-bordered table-striped">
                            </table>
                        </div>
                        <!-- /.card-body -->
                    </div>
                    <!-- /.card -->
                </div>
                <!-- /.col -->
            </div>
            <!-- /.row -->
        </div>
        <!-- /.container-fluid -->
    </section>
    <!-- /.content -->
</div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

{% include 'core/html/includes/core/javascripts.html' %}
{% include 'core/html/includes/index/javascripts.html' %}
<!-- ------------------- -->
<script>const api = axios.create({ baseURL: '{{prefix_url_post}}', timeout: 2000, withCredentials: true });
    api.interceptors.request.use(config => {
        const accessToken = localStorage.getItem("access_token");
        if (accessToken) {
            config.headers["Authorization"] = `Bearer ${accessToken}`;
        }
        return config;
    }, error => Promise.reject(error));
    api.interceptors.response.use(
        response => response,  // Kalau response sukses, langsung return
        async error => {
            const originalRequest = error.config;  // Simpan request yang gagal

            // Jika response error karena token expired (401)
            if (error.response.status === 401 && !originalRequest._retry) {
                originalRequest._retry = true;  // Hindari infinite loop

                try {
                    // Panggil endpoint refresh token ke backend
                    const refreshResponse = await axios.post("http://localhost:8000/refresh", {}, { withCredentials: true });

                    // Simpan token baru di localStorage
                    localStorage.setItem("access_token", refreshResponse.data.access_token);

                    // Set ulang Authorization header dengan token baru
                    originalRequest.headers["Authorization"] = `Bearer ${refreshResponse.data.access_token}`;

                    // Coba ulang request yang gagal dengan token baru
                    return api(originalRequest);
                } catch (refreshError) {
                    console.error("Refresh token gagal, user harus login ulang:", refreshError);
                }
            }

            return Promise.reject(error);
        }
    );
</script>
<script src="{{prefix_url_js}}/index.js"></script>

{% endblock javascripts %}